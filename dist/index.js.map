{"version":3,"sources":["index.js"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;IAYqB,OAAO;AAC3B,UADoB,OAAO,CACb,MAAM,EAAG;wBADH,OAAO;;AAE1B,MAAI,CAAC,WAAW,GAAG,OAAO,CAAC,GAAG,CAAC,QAAQ,IAAI,aAAa,CAAC;AACzD,MAAI,CAAC,MAAM,GAAG,IAAI,CAAC,UAAU,CAAE,MAAM,CAAE,CAAC;AACxC,MAAI,CAAC,KAAK,CAAE,IAAI,CAAC,MAAM,CAAE,CAAC;AAC1B,MAAI,CAAC,OAAO,CAAC;;AAGb,MAAI,SAAS,GAAG,OAAO,CAAC,GAAG,CAAC,kBAAkB,CAAC;AAC/C,MAAK,SAAS,EAAG;AAChB,OAAI,CAAC,OAAO,GAAG,mBAAS,MAAM,CAAE,SAAS,CAAE,CAAC;GAC5C,MAAM;AACN,OAAI,CAAC,OAAO,GAAG,mBAAS,MAAM,EAAE,CAAC;GACjC;EACD;;cAdmB,OAAO;;;;;;;;wBAyBnB,MAAM,EAAG,EAEhB;;;;;;;;;;;;;;;;6BAcY,SAAS,EAAG;;;AAExB,UAAO,IAAI,CAAC,eAAe,CAAE,SAAS,CAAC,IAAI,EAAE,SAAS,CAAC,IAAI,EAAE,SAAS,CAAC,GAAG,EAAE,SAAS,CAAC,IAAI,CAAE,CAC1F,GAAG,CAAE,UAAE,OAAO,EAAM;AACpB,QAAI,GAAG,GAAG;AACT,SAAI,EAAE,SAAS,CAAC,IAAI;AACpB,SAAI,EAAE,SAAS,CAAC,IAAI;AACpB,QAAG,EAAE,SAAS,CAAC,GAAG;AAClB,SAAI,EAAE,OAAO,CAAC,IAAI;AAClB,cAAS,EAAE,SAAS,CAAC,SAAS;KAC9B,CAAC;AACF,WAAO,AAAC,OAAO,CAAC,IAAI,KAAK,KAAK,IAAI,SAAS,CAAC,SAAS,KAAK,IAAI,GAAI,MAAK,UAAU,CAAE,GAAG,CAAE,GAAG,OAAO,CAAC;IACnG,CAAE,CACF,MAAM,CAAE,UAAE,CAAC,EAAE,CAAC,EAAM;AACpB,WAAO,CAAC,CAAC,MAAM,CAAE,CAAC,CAAE,CAAA;IACpB,EAAE,EAAE,CAAE,CACN,IAAI,CAAE,UAAE,IAAI,EAAM;AAClB,WAAO,SAAS,CAAC,MAAM,GAAG,MAAK,OAAO,CAAE,IAAI,EAAE,SAAS,CAAC,MAAM,CAAE,GAAG,mBAAQ,OAAO,CAAE,IAAI,CAAE,CAAC;IAC3F,CAAE,CAAC;GACL;;;;;;;;;;8BAOa,YAAY,EAAG;;;AAC5B,OAAI,kBAAkB,GAAG,EAAE,CAAC;AAC5B,eAAY,CAAC,OAAO,CAAE,UAAE,GAAG,EAAM;AAChC,sBAAkB,CAAC,IAAI,CAAE,OAAK,UAAU,CAAE,GAAG,CAAE,CAAE,CAAC;IAClD,CAAE,CAAC;AACJ,UAAO,mBAAQ,GAAG,CAAE,kBAAkB,CAAE,CAAC;GACzC;;;8BAEa,aAAa,EAAE,YAAY,EAAE,MAAM,EAAG;;AAEnD,OAAI,IAAI,GAAG,IAAI,CAAC;AAChB,UAAO,uBAAa,UAAE,QAAQ,EAAE,QAAQ,EAAM;AAC7C,QAAI,WAAW,GAAG,eAAK,OAAO,CAAE,IAAI,CAAC,eAAe,CAAE,MAAM,EAAE,aAAa,CAAC,IAAI,EAAE,YAAY,CAAE,CAAE,CAAC;;AAEnG,qBAAO,IAAI,CAAE,eAAK,OAAO,CAAE,WAAW,CAAE,CAAE,CAAC;AAC3C,QAAI,IAAI,GAAG,aAAG,iBAAiB,CAAE,WAAW,CAAE,CAAC;AAC/C,oBAAM,GAAG,CAAE,aAAa,CAAC,YAAY,EAAE,UAAE,QAAQ,EAAM;AACtD,aAAQ,CAAC,EAAE,CAAE,MAAM,EAAE,UAAE,IAAI,EAAM;AAChC,UAAI,CAAC,KAAK,CAAE,IAAI,CAAE,CAAC;MACnB,CAAE,CAAC,EAAE,CAAE,KAAK,EAAE,YAAM;AACpB,UAAI,CAAC,GAAG,EAAE,CAAC;AACX,cAAQ,CAAE,IAAI,CAAC,IAAI,CAAE,CAAC;MACtB,CAAE,CAAA;KACH,CAAE,CAAC,EAAE,CAAE,OAAO,EAAE,UAAE,GAAG,EAAM;AAC3B,aAAQ,CAAE,GAAG,CAAE,CAAC;KAChB,CAAE,CAAC;IACJ,CAAE,CAAC;GACJ;;;;;;;;;;;8BAQa,aAAa,EAAE,MAAM,EAAG,EAErC;;;+BAEc,cAAc,EAAG,EAE/B;;;;;;;;;;;;;;4BAWU,IAAI,EAAG;AACjB,OAAI,yBAAE,OAAO,CAAE,IAAI,CAAE,EAAE;AACtB,WAAO,IAAI,CAAC;IACZ,MAAM;AACN,QAAI,CAAC,GAAG,EAAE,CAAC;AACX,KAAC,CAAC,IAAI,CAAE,IAAI,CAAE,CAAC;AACf,WAAO,CAAC,CAAC;IACT;GACD;;;;;;;;;;;;0BAUS,IAAI,EAAE,MAAM,EAAG;;AAExB,SAAM,GAAG,MAAM,IAAI,CAAC,KAAK,EAAE,MAAM,CAAC,CAAC;AACnC,OAAI,YAAY;;AAAC,AAEjB,OAAK,yBAAE,OAAO,CAAE,IAAI,CAAE,EAAG;AACxB,gBAAY,GAAG,yBAAE,cAAc,CAAE,IAAI,EAAE,MAAM,EAAE,MAAM,CAAE,CAAC;IACxD;AACD,UAAO,mBAAQ,OAAO,CAAE,YAAY,IAAI,IAAI,CAAE,CAAC;GAC/C;;;;;;;;;;6BAOY,cAAc,EAAG;AAC7B,OAAI,aAAa,GAAG;AACnB,WAAO,EAAE,OAAO;AAChB,SAAK,EAAE,KAAK;AACZ,YAAQ,EAAE,OAAO;AACjB,WAAO,EAAE,IAAI;IACb,CAAC;AACF,UAAO,6BAAQ,aAAa,EAAE,cAAc,CAAE,CAAC;GAC/C;;;;;;;;;;;;kCASiB,IAAI,EAAE,IAAI,EAAE,GAAG,EAAE,IAAI,EAAG;;;AACzC,UAAO,uBAAa,UAAE,QAAQ,EAAE,QAAQ,EAAM;AAC7C,WAAK,OAAO,CAAC,IAAI,CAAE,IAAI,GAAG,GAAG,GAAG,IAAI,EAAE,GAAG,CAAE,CAAC,QAAQ,CAAE,IAAI,EAAE,UAAE,GAAG,EAAE,IAAI,EAAM;AAC5E,SAAK,GAAG,EAAG;AACV,cAAQ,CAAE,GAAG,CAAE,CAAC;MAChB,MAAM;AACN,cAAQ,CAAE,OAAK,SAAS,CAAE,IAAI,CAAE,CAAC,CAAC;MAClC;KACD,CAAE,CAAC;IACJ,CAAE,CAAC;GACJ;;;;;;;;;;;;;kCAUiB,WAAW,EAAE,UAAU,EAAE,UAAU,EAAG;;AAEvD,OAAI,aAAa,GAAG,WAAW,CAAC;AAChC,OAAI,IAAI,GAAG,sBAAG,UAAU,CAAE,CAAC,SAAS,CAAE,UAAU,CAAE,CAAC,SAAS,CAAE,GAAG,CAAE,CAAC,CAAC,CAAC;;AAEtE,UAAO,eAAK,SAAS,CAAE,eAAK,IAAI,CAAE,aAAa,EAAE,IAAI,CAAE,CAAE,CAAC;GAC1D;;;sBApLa;AACb,UAAO,IAAI,CAAC,OAAO,CAAC;GACpB;;;QAlBmB,OAAO;;;kBAAP,OAAO","file":"index.js","sourcesContent":["import Promise from \"bluebird\";\r\nimport lodashDeep from \"lodash-deep\";\r\nimport yaml from \"js-yaml\";\r\nimport fs from \"fs\";\r\nimport https from \"https\";\r\nimport extend from \"extend-shallow\";\r\nimport _ from \"./lodash-extended\";\r\nimport path from \"path\";\r\nimport S from \"string\";\r\nimport mkdirp from \"mkdirp\";\r\nimport octonode from \"octonode\";\r\n\r\nexport default class Sammler {\r\n\tconstructor ( config ) {\r\n\t\tthis.environment = process.env.NODE_ENV || \"development\";\r\n\t\tthis.config = this._getConfig( config );\r\n\t\tthis._init( this.config );\r\n\t\tthis._client;\r\n\r\n\r\n\t\tvar authToken = process.env.NODE_SAMMLER_TOKEN;\r\n\t\tif ( authToken ) {\r\n\t\t\tthis._client = octonode.client( authToken );\r\n\t\t} else {\r\n\t\t\tthis._client = octonode.client();\r\n\t\t}\r\n\t}\r\n\r\n\tget client () {\r\n\t\treturn this._client;\r\n\t}\r\n\r\n\t/**\r\n\t * Initialize the instance of Sammler.\r\n\t * @param config\r\n\t * @private\r\n\t */\r\n\t_init ( config ) {\r\n\r\n\t}\r\n\r\n\r\n\t/**\r\n\t * Get the content of a given source-definition.\r\n\t * @param {Object} sourceDef\r\n\t * @param {String} sourceDef.user - The user (e.g. `stefanwalther`). Mandatory.\r\n\t * @param {String} sourceDef.repo - Name of the repository (e.g. `sammler-test-repo1`). Mandatory.\r\n\t * @param {String?} sourceDef.ref - The branch, defaults to `master`.\r\n\t * @param {String?} sourceDef.path - Path to fetch contents from (e.g. `dir-1` n sammler-test-repo1). Defaults to \"\".\r\n\t * @param {Boolean?} sourceDef.recursive - Whether to fetch contents recursively or not, defaults to false.\r\n\t *\r\n\t * @returns {*}\r\n\t */\r\n\tgetContent ( sourceDef ) {\r\n\r\n\t\treturn this._getRepoContent( sourceDef.user, sourceDef.repo, sourceDef.ref, sourceDef.path )\r\n\t\t\t.map( ( content ) => {\r\n\t\t\t\tlet def = {\r\n\t\t\t\t\tuser: sourceDef.user,\r\n\t\t\t\t\trepo: sourceDef.repo,\r\n\t\t\t\t\tref: sourceDef.ref,\r\n\t\t\t\t\tpath: content.path,\r\n\t\t\t\t\trecursive: sourceDef.recursive\r\n\t\t\t\t};\r\n\t\t\t\treturn (content.type === \"dir\" && sourceDef.recursive === true) ? this.getContent( def ) : content;\r\n\t\t\t} )\r\n\t\t\t.reduce( ( a, b ) => {\r\n\t\t\t\treturn a.concat( b )\r\n\t\t\t}, [] )\r\n\t\t\t.then( ( data ) => {\r\n\t\t\t\treturn sourceDef.filter ? this._filter( data, sourceDef.filter ) : Promise.resolve( data );\r\n\t\t\t} );\r\n\t}\r\n\r\n\t/**\r\n\t * Returns the collection of source-definitions.\r\n\t * @param sourceDefArr\r\n\t * @returns {Promise}\r\n\t */\r\n\tgetContents ( sourceDefArr ) {\r\n\t\tlet getContentPromises = [];\r\n\t\tsourceDefArr.forEach( ( def ) => {\r\n\t\t\tgetContentPromises.push( this.getContent( def ) );\r\n\t\t} );\r\n\t\treturn Promise.all( getContentPromises );\r\n\t}\r\n\r\n\tsaveContent ( gitHubContent, requestedDir, target ) {\r\n\r\n\t\tlet that = this;\r\n\t\treturn new Promise( ( resolved, rejected ) => {\r\n\t\t\tlet localTarget = path.resolve( that._getLocalTarget( target, gitHubContent.path, requestedDir ) );\r\n\r\n\t\t\tmkdirp.sync( path.dirname( localTarget ) );\r\n\t\t\tlet file = fs.createWriteStream( localTarget );\r\n\t\t\thttps.get( gitHubContent.download_url, ( response ) => {\r\n\t\t\t\tresponse.on( \"data\", ( data ) => {\r\n\t\t\t\t\tfile.write( data );\r\n\t\t\t\t} ).on( \"end\", () => {\r\n\t\t\t\t\tfile.end();\r\n\t\t\t\t\tresolved( file.path );\r\n\t\t\t\t} )\r\n\t\t\t} ).on( \"error\", ( err ) => {\r\n\t\t\t\trejected( err );\r\n\t\t\t} );\r\n\t\t} );\r\n\t}\r\n\r\n\t/**\r\n\t * Save a GitHub content to disk.\r\n\t * @param gitHubContent\r\n\t * @param target\r\n\t * @private\r\n\t */\r\n\t_saveToDisk ( gitHubContent, target ) {\r\n\r\n\t}\r\n\r\n\tsaveContents ( sourceDefArray ) {\r\n\r\n\t}\r\n\r\n\t// ****************************************************************************************\r\n\t// Private methods\r\n\t// ****************************************************************************************\r\n\t/**\r\n\t * Arrayify an item.\r\n\t * @param item\r\n\t * @returns {*}\r\n\t * @private\r\n\t */\r\n\t_arrayIfy( item ) {\r\n\t\tif (_.isArray( item )) {\r\n\t\t\treturn item;\r\n\t\t} else {\r\n\t\t\tlet x = [];\r\n\t\t\tx.push( item );\r\n\t\t\treturn x;\r\n\t\t}\r\n\t}\r\n\r\n\r\n\t/**\r\n\t * Filter either only directories, files or both from a given result-set.\r\n\t * @param data\r\n\t * @param {Array} filter The given filter, containing the following possible values: [\"dir\"], [\"file\"] or [\"dir\", \"file\"]. Defaults to the latter one.\r\n\t * @private\r\n\t * @returns {Promise.<*>}\r\n\t */\r\n\t_filter ( data, filter ) {\r\n\r\n\t\tfilter = filter || [\"dir\", \"file\"];\r\n\t\tvar filteredData;\r\n\t\t// only array of returned contents can be filtered, not a single item.\r\n\t\tif ( _.isArray( data ) ) {\r\n\t\t\tfilteredData = _.filterByValues( data, \"type\", filter );\r\n\t\t}\r\n\t\treturn Promise.resolve( filteredData || data );\r\n\t}\r\n\r\n\t/**\r\n\t * Get the current config\r\n\t * @param instanceConfig\r\n\t * @private\r\n\t */\r\n\t_getConfig ( instanceConfig ) {\r\n\t\tlet defaultConfig = {\r\n\t\t\tversion: \"3.0.0\",\r\n\t\t\tdebug: false, //(this.environment === 'development') ? true : false,\r\n\t\t\tprotocol: \"https\",\r\n\t\t\ttimeout: 5000\r\n\t\t};\r\n\t\treturn extend( defaultConfig, instanceConfig );\r\n\t}\r\n\r\n\t/**\r\n\t * Promisified call to get the content using octonode.\r\n\t * (Since octonode is just used here and in _init, octonode could be replaced easily with another lib)\r\n\t * @param rep\r\n\t * @param ref\r\n\t * @param path\r\n\t */\r\n\t_getRepoContent ( user, repo, ref, path ) {\r\n\t\treturn new Promise( ( resolved, rejected ) => {\r\n\t\t\tthis._client.repo( user + \"/\" + repo, ref ).contents( path, ( err, data ) => {\r\n\t\t\t\tif ( err ) {\r\n\t\t\t\t\trejected( err );\r\n\t\t\t\t} else {\r\n\t\t\t\t\tresolved( this._arrayIfy( data ));\r\n\t\t\t\t}\r\n\t\t\t} );\r\n\t\t} );\r\n\t}\r\n\r\n\t/**\r\n\t * Return a local target for a given gitHub file.\r\n\t * @param {String} localTarget - Local base target\r\n\t * @param {Object} gitHubFile - The GitHub content definition of a single file.\r\n\t * @param {String} gitHubPath\r\n\t * @returns {string}\r\n\t * @private\r\n\t */\r\n\t_getLocalTarget ( localTarget, gitHubFile, gitHubPath ) {\r\n\r\n\t\tlet baseLocalPath = localTarget;\r\n\t\tlet file = S( gitHubFile ).chompLeft( gitHubPath ).chompLeft( '/' ).s;\r\n\r\n\t\treturn path.normalize( path.join( baseLocalPath, file ) );\r\n\t}\r\n\r\n\r\n}\r\n"],"sourceRoot":"D:\\Projects\\private-projects\\sammler\\lib"}